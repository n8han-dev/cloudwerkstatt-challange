---
- name: Ensure groups are present
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ users | map(attribute='groups') | flatten | unique }}"
  # in case we'll have more groups for users

- name: Create user accounts
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid }}"
    shell: "{{ item.shell }}"
    home: "{{ item.home }}"
    groups: "{{ item.groups | join(',') }}"
    append: no # also default behavior, specified for clarity
    state: present
    password_expire: yes
    expires: "{{ (item.expiry | to_datetime('%Y-%m-%d')).timestamp() | int }}"
  loop: "{{ users }}"